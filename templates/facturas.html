{% extends "base.html" %} {% load static %}

{% block head %}

<div class="d-flex">
  <h1 class="h2 me-4">Facturas</h1>
  {% include 'include/buscador.html' %}
</div>

{% endblock %} 

{% block content %}

<!-- -------------------------------------------------------- -->
<div class="d-flex align-items-center gap-3">
  <form class="input-group buscador mt-4" method="GET">
    <input
      type="text"
      class="form-control"
      name="buscar_cliente"
      placeholder="Buscador"
      value="{{ request.GET.buscar_cliente}}"
      id="buscar_cliente"
    />
    <button type="submit" class="btn btn-outline-secondary">
      <i class="bi bi-search"></i>
    </button>
  </form>
  
  <button
      type="button"
      class="btn btn-primary mt-4"
      onclick="abrir_modal_add_client('{% url 'agregar_cliente' %}')"
    >
      Añadir 
      <svg width="16" height="16" fill="currentColor" class="bi bi-plus-circle-fill" viewBox="0 0 16 16">
        <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3v-3z"/>
      </svg>
  </button>
</div>


<div
  class="modal fade"
  id="addModalClient"
  tabindex="-1"
  aria-hidden="true"
></div>

<!-- -------------------------------------------------------- -->

<div class="overflow-auto">
  <table class="table table-striped table-hover mt-4" style="min-width: 38rem !important">
    <thead>
      <tr>
        <th>RUN</th>
        <th>Nombre</th>
        <th>Correo</th>
        <th>Teléfono</th>
      </tr>
    </thead>
    <tbody id="datos_cliente">
      <tr><td colspan="4">INGRESE AL CLIENTE</td></tr>
    </tbody>
  </table>
</div>

<!-- ---------------------------------------------------------------- -->

<div class="d-flex gap-4 tablaCompra"> 
  <div class="overflow-auto conTabla">
    <table class="table table-striped table-hover mt-4" id="table-venta" style="min-width: 38rem !important">
      <thead>
        <tr>
          <th>Código</th>
          <th>Descripción</th>
          <th>Cantidad</th>
          <th>Precio</th>
          <th>Total</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <form class="mt-4">
    <p>
      <label>Subtotal</label>
      <input
        type="number"
        name="subtotal"
        class="form-control"
        readonly="readonly"
      />
    </p>
    <p>
      <label>Impuesto</label>
      <input
        type="number"
        name="impuestos"
        class="form-control"
        readonly="readonly"
      />
    </p>
    <p>
      <label>
       <strong>Total</strong> 
      </label>
      <input
        type="number"
        name="total"
        class="form-control total"
        readonly="readonly"
      />
    </p>
  </form>
</div>

<div id="containerBtnVentas" class="mt-3 d-flex none">
  <button class="btn btn-danger me-3" id="btnLimpiarVenta">
    Eliminar Venta
  </button>

  <form
    action="{% url 'Facturas' %}"
    method="post"
    enctype="multipart/form-data"
    id="formDatosVenta"
  >
    {% csrf_token %}

    <span>{{ form.cliente_id }}</span>
    <span>{{ form.carrito }}</span>

    <button type="button" class="btn btn-primary" id="btnSumitVenta">
      Generar Venta
    </button>

    {% if error_message %}
    <div class="alert-login">{{ error_message }}</div>
    {% endif %}
  </form>
</div>



<!-- TERMINAR DE REVISAR ---->
{% if request.GET.buscar_cliente and object_list %}
  {% for cliente in object_list %}

<script>

  const clienteID = document.getElementById("id_cliente");
  clienteID.value =  {{ cliente.id_cliente }};

  const tableBodyCliente = document.getElementById("datos_cliente");

  if (clienteID.value){

    localStorage.removeItem("cliente");

    const clienteInfo = {
      run: '{{ cliente.run_cliente }}',
      nombreCompleto: '{{ cliente.nombre_cliente }} {{ cliente.apellido_cliente }}',
      correo: '{{ cliente.correo_cliente }}',
      telefono: '{{ cliente.telefono_cliente }}'
    };

    // Convertir el objeto a una cadena JSON
    const clienteInfoJSON = JSON.stringify(clienteInfo);

    // Guardar en el localStorage
    localStorage.setItem('cliente', clienteInfoJSON);

    // Crea la tabla 
    tableBodyCliente.innerHTML = "";

    // Recuperar la información del cliente desde localStorage
    const clienteDatosLocal = localStorage.getItem('cliente');
    
    if (clienteDatosLocal){
      const clienteDatos = JSON.parse(clienteInfoJSON);
      
      let filaCLiente = document.createElement("tr");
  
      let run = document.createElement("td");
      run.textContent =  clienteDatos.run;
  
      let nombreCliente = document.createElement("td");
      nombreCliente.textContent = clienteDatos.nombreCompleto;
  
      let correoCliente = document.createElement("td");
      correoCliente.textContent =  clienteDatos.correo;
  
      let telefonoCliente = document.createElement("td");
      telefonoCliente.textContent =  clienteDatos.telefono;
  
  
      filaCLiente.appendChild(run);
      filaCLiente.appendChild(nombreCliente);
      filaCLiente.appendChild(correoCliente);
      filaCLiente.appendChild(telefonoCliente);
  
      tableBodyCliente.appendChild(filaCLiente);
    }

  }

</script>
        
  {% endfor %}
{% elif request.GET.buscar and object_list %}
  {% for producto in object_list %}
    {% if producto.tipo_medida == 1 %}

<script>
  document.addEventListener("DOMContentLoaded", function () {
    agregarAlCarrito(
      {{ producto.id_producto }},
      '{{ producto.codigo_producto }}',
      '{{ producto.descripcion_producto }}',
      '{{ producto.stock }}',
      {{ producto.precio_venta }},
      {{ producto.tipo_medida }},
      {{ producto.tipo_impuesto }}
    );

  });
</script>

    {% else %}

<button
  type="button"
  id="abrirCantidadModal"
  class="visually-hidden"
  data-bs-toggle="modal"
  data-bs-target="#cantidadModal"
>
  <i class="bi bi-cart-plus"></i>
</button>

{% include 'include/modalCantidad.html' %}

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const abrirModal = document.getElementById("abrirCantidadModal");

    datosProducto({{ producto.id_producto }},'{{ producto.codigo_producto }}','{{ producto.descripcion_producto }}','{{ producto.stock }}',{{ producto.precio_venta }},{{ producto.tipo_medida }},{{ producto.tipo_impuesto }});

    abrirModal.click();

  });
</script>

    {% endif %}
  {% endfor %}
{% endif %}

{% for message in messages %}
  {% if "success-factura" in message.tags %}

<script defer src="{% static 'js/factura.js' %}"></script>

  {% endif %}
{% endfor %}

{% endblock %} 

{% block script %}

<script defer src="{% static 'js/ventas.js' %}"></script>
<script defer src="{% static 'js/submitVentas.js' %}"></script>
<script defer src="{% static 'js/autoFocus.js' %}"></script>

{% endblock %}
